class POST_AI{constructor(){this.root="https://summary.tianli0.top",this.aiTalkMode=!1,this.aiPostExplanation="",this.config=GLOBAL_CONFIG.post_ai,this.scoGPTIsRunning=!1,console.log("%c TianliGPT %c 文章摘要 %c https://postchat.zhheo.com","background:#35495e ; padding: 1px; border-radius: 3px 0 0 3px;  color: #fff","background:#ff9a9a ; padding: 1px; border-radius: 0 3px 3px 0;  color: #fff","background:unset ; padding: 1px; border-radius: 0 3px 3px 0;  color: #fff")}init(){document.querySelector(".ai-explanation")&&(this.scoGPTIsRunning=!1,this.aiPostExplanation=PAGE_CONFIG.ai_text||"",this.aiPostExplanation?this.aiShowAnimation(Promise.resolve(this.aiPostExplanation)):this.generate(),this.AIEngine())}getTitleAndContent(){const t=document.getElementById("article-container"),e=document.title,n=t.getElementsByTagName("p");return(e+" "+[...t.querySelectorAll("h1, h2, h3, h4, h5"),...n].map((t=>t.innerText.replace(/https?:\/\/[^\s]+/g,""))).join(" ")).slice(0,1e3)}async generate(){const t=document.title,e=this.getTitleAndContent(),n=this.config.key;this.aiShowAnimation(this.fetch(t,e,n))}async fetch(t,e,n){const i=`${this.root}/?content=${encodeURIComponent(e)}&title=${t}&key=${encodeURIComponent(n)}&url=${encodeURIComponent(window.location.href)}`;try{const t=await fetch(i),e=await t.json();return t.ok?(this.aiPostExplanation=e.summary,e.summary):(console.error("Request failed:",e.err_msg),e.err_msg)}catch(t){return console.error("Fetch error:",t),"Error fetching data"}}aiShowAnimation(t,e=!1,n=0){const i=document.querySelector(".ai-explanation"),s=document.querySelector(".ai-tag");i&&!this.scoGPTIsRunning&&(this.scoGPTIsRunning=!0,this.cleanSuggestions(),s.classList.add("loadingAI"),i.style.display="block",i.innerHTML='生成中...<span class="blinking-cursor"></span>',setTimeout((()=>{let n,o,a=0,r=!0,c=!0;const l=new IntersectionObserver((t=>{r=t[0].isIntersecting,r&&requestAnimationFrame(o)}),{threshold:0});t.then((t=>{n=performance.now(),o=()=>{if(a<t.length&&r){const c=performance.now(),h=c-n,g=t.slice(a,a+1),d=/[，。！、？,.!?]/.test(g),u=/[a-zA-Z0-9]/.test(g);h>=(d?100*Math.random()+100:u?10:25)&&(i.innerText=t.slice(0,a+1),n=c,a++,a<t.length?i.innerHTML=t.slice(0,a)+'<span class="blinking-cursor"></span>':(i.innerHTML=t,i.style.display="block",this.scoGPTIsRunning=!1,s.classList.remove("loadingAI"),l.disconnect(),e&&this.createSuggestions())),r&&requestAnimationFrame(o)}},r&&c&&(requestAnimationFrame(o),c=!1),l.observe(i)})).catch((t=>{console.error("检索信息失败：",t),i.innerHTML="检索信息失败",i.style.display="block",this.scoGPTIsRunning=!1,s.classList.remove("loadingAI"),l.disconnect()}))}),n))}AIEngine(){const t=document.querySelector(".ai-tag");t&&t.addEventListener("click",(()=>{this.scoGPTIsRunning||(this.aiTalkMode=!0,this.aiShowAnimation(Promise.resolve(this.config.talk),!0))}))}cleanSuggestions(){const t=document.querySelector(".ai-suggestions");t?t.innerHTML="":console.error("没有这个元素：'ai-suggestions'")}createSuggestions(){this.aiTalkMode&&(this.cleanSuggestions(),this.createSuggestionItemWithAction("这篇文章讲了什么？",(()=>{""===this.aiPostExplanation?setTimeout((()=>{this.generate()}),3e3):setTimeout((()=>{this.aiShowAnimation(Promise.resolve(this.aiPostExplanation),!0)}),3e3)})),this.config.randomPost&&this.createSuggestionItemWithAction("带我去看看其他文章",(()=>toRandomPost())),this.aiTalkMode=!0)}createSuggestionItemWithAction(t,e){const n=document.querySelector(".ai-suggestions");if(!n)return void console.error("无法找到具有class为ai-suggestions的元素");const i=document.createElement("div");i.classList.add("ai-suggestions-item"),i.textContent=t,i.addEventListener("click",e),n.appendChild(i)}}const ai=new POST_AI;